version: '3'
services:
  devcontainer:
    # Use the published NixOS image or build locally
    image: ghcr.io/lucernae/devcontainer-nix:nixos--nixos-25.11

    privileged: true
    tty: true

    volumes:
      # Mount workspace
      - ../../:/workspace:cached

      # Persist Nix store across container rebuilds
      # Local: uses named volume 'nix-store'
      # Codespaces: set NIX_STORE_SOURCE to bind mount path for persistence
      - ${NIX_STORE_SOURCE:-nix-store}:/nix

      # Mount NixOS configuration (traditional)
      - ./etc/nixos/configuration.nix:/etc/nixos/configuration.nix

      # Mount NixOS flake configuration (flake-based)
      - ./etc/nixos/flake.nix:/etc/nixos/flake.nix

      # Mount home-manager configuration for the vscode user
      - ./home.nix:/home/vscode/home.nix

      # Docker socket for docker-in-docker
      - /var/run/docker.sock:/var/run/docker.sock

      # Mask tmp.mount so systemd doesn't mount /tmp as tmpfs
      - ./etc/systemd/system/tmp.mount:/etc/systemd/system/tmp.mount

      # Systemd cgroup mount
      - /sys/fs/cgroup:/sys/fs/cgroup:rw

    tmpfs:
      - /cont/tmp:exec,mode=777
      - /run

    hostname: ai-nixos-devcontainer

    environment:
      container: "docker"
      SHELL: "sh"
      PATH: "/run/wrappers/bin:/bin:/usr/bin:/usr/sbin:/run/current-system/sw/bin/"
      TMPDIR: "/cont/tmp"
      VSCODE_SERVER_CUSTOM_GLIBC_LINKER: "true"
      __NIXOS_SET_ENVIRONMENT_DONE: "true"
      # Allow unfree packages (VS Code, etc.)
      NIXPKGS_ALLOW_UNFREE: "1"
      # Placeholder for Claude Code API key (set this in your environment)
      # ANTHROPIC_API_KEY: "your-api-key-here"
      USER: "vscode" # must be consistent with remoteUser in devcontainer.json

    cap_add:
      - SYS_ADMIN
      - CAP_NET_ADMIN

    # Required for systemd with cgroupv2
    cgroup: host

    stop_signal: SIGRTMIN+3

volumes:
  nix-store:
    driver: local

version: '3'
services:
  # Update this to the name of the service you want to work with in your docker-compose.yml file
  devcontainer:
    # If you want add a non-root user to your Dockerfile, you can use the "remoteUser"
    # property in devcontainer.json to cause VS Code its sub-processes (terminals, tasks, 
    # debugging) to execute as the user. Uncomment the next line if you want the entire 
    # container to run as this user instead. Note that, on Linux, you may need to 
    # ensure the UID and GID of the container user you create matches your local user. 
    # See https://aka.ms/vscode-remote/containers/non-root for details.
    #
    # user: vscode

    # Uncomment if you want to override the service's Dockerfile to one in the .devcontainer 
    # folder. Note that the path of the Dockerfile and context is relative to the *primary* 
    # docker-compose.yml file (the first in the devcontainer.json "dockerComposeFile"
    # array). The sample below assumes your primary file is in the root of your project.
    #
    # uncomment the build section when you want to rebuild
#    build:
#      context: .
#      dockerfile: Dockerfile
#      args:
#        - NIXOS_VERSION=nixos-25.11
    image: ghcr.io/lucernae/devcontainer-nix:nixos--nixos-25.11
    privileged: true
    tty: true
    volumes:
      # Update this to wherever you want VS Code to mount the folder of your project
      - ../../:/workspace:cached
      - ./etc/nixos/configuration.nix:/etc/nixos/configuration.nix

      # Uncomment the next line to use Docker from inside the container. See https://aka.ms/vscode-remote/samples/docker-from-docker-compose for details.
      - /var/run/docker.sock:/var/run/docker.sock

      # Mask tmp.mount so systemd doesn't mount /tmp as tmpfs
      # (required for docker cp to work â€” e.g. for antigravity devcontainer server install)
      - ./etc/systemd/system/tmp.mount:/etc/systemd/system/tmp.mount

      # Systemd related mount
      - /sys/fs/cgroup:/sys/fs/cgroup:rw

    tmpfs:
      - /cont/tmp:exec,mode=777
      - /run

    hostname: devcontainer

    environment:
      container: "docker"
      # Needed for devcontainer's host probe to work with our /bin compatibility
      SHELL: "sh"
      PATH: "/run/wrappers/bin:/bin:/usr/bin:/usr/sbin:/run/current-system/sw/bin/"
      TMPDIR: "/cont/tmp"
      VSCODE_SERVER_CUSTOM_GLIBC_LINKER: "true"
      # Needed to let any devcontainer (jetbrains) host runner to access bash /etc/profile
      __NIXOS_SET_ENVIRONMENT_DONE: "true"

    cap_add:
      - SYS_ADMIN
      - CAP_NET_ADMIN

    # Required for systemd to create /init.scope on cgroupv2 hosts with nsdelegate
    cgroup: host

    stop_signal: SIGRTMIN+3
    # systemd uses init binary as PID 1, so we should not override the entrypoint or cmd

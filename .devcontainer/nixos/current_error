[Info	- 13:27:12.133] Resolving dev container authority 'dev-container+7b22776f726b737061636550617468223a222f686f6d652f6c756365726e61652f576f726b696e674469722f706572736f6e616c2f646576636f6e7461696e65722d6e6978222c22646576636f6e7461696e657250617468223a222f686f6d652f6c756365726e61652f576f726b696e674469722f706572736f6e616c2f646576636f6e7461696e65722d6e69782f2e646576636f6e7461696e65722f6e69786f732f646576636f6e7461696e65722e6a736f6e227d' (attempt #1) container '{"workspacePath":"/home/lucernae/WorkingDir/personal/devcontainer-nix","devcontainerPath":"/home/lucernae/WorkingDir/personal/devcontainer-nix/.devcontainer/nixos/devcontainer.json"}'
[Info	- 13:27:12.134] setup devContainers
[Info	- 13:27:12.134] Starting Antigravity Dev Containers...
[Info	- 13:27:12.134] Checking docker version runs
[Info	- 13:27:12.167] Docker version: Client:
 Version:           28.5.2
 API version:       1.51
 Go version:        go1.25.6
 Git commit:        v28.5.2
 Built:             Thu Jan  1 00:00:00 1970
 OS/Arch:           linux/amd64
 Context:           default

Server:
 Engine:
  Version:          28.5.2
  API version:      1.51 (minimum version 1.24)
  Go version:       go1.25.6
  Git commit:       v28.5.2
  Built:            Tue Jan  1 00:00:00 1980
  OS/Arch:          linux/amd64
  Experimental:     false
 containerd:
  Version:          v2.2.1
  GitCommit:        refs/tags/v2.2.1
 runc:
  Version:          1.3.3
  GitCommit:        
 docker-init:
  Version:          0.19.0
  GitCommit:        

[Info	- 13:27:12.167] Start devcontainer up ...
[2026-02-19T13:27:12.351Z] @devcontainers/cli 0.72.0. Node.js v22.21.1. linux 6.12.70 x64.
[2026-02-19T13:27:12.351Z] Start: Run: docker buildx version
[2026-02-19T13:27:12.414Z] Stop (63 ms): Run: docker buildx version
[2026-02-19T13:27:12.414Z] github.com/docker/buildx v0.29.1 
[2026-02-19T13:27:12.415Z] 
[2026-02-19T13:27:12.415Z] Start: Run: docker -v
[2026-02-19T13:27:12.432Z] Stop (17 ms): Run: docker -v
[2026-02-19T13:27:12.432Z] Start: Resolving Remote
[2026-02-19T13:27:12.435Z] Start: Run: docker ps -q -a --filter label=devcontainer.local_folder=/home/lucernae/WorkingDir/personal/devcontainer-nix --filter label=devcontainer.config_file=/home/lucernae/WorkingDir/personal/devcontainer-nix/.devcontainer/nixos/devcontainer.json
[2026-02-19T13:27:12.453Z] Stop (18 ms): Run: docker ps -q -a --filter label=devcontainer.local_folder=/home/lucernae/WorkingDir/personal/devcontainer-nix --filter label=devcontainer.config_file=/home/lucernae/WorkingDir/personal/devcontainer-nix/.devcontainer/nixos/devcontainer.json
[2026-02-19T13:27:12.453Z] Start: Run: docker ps -q -a --filter label=devcontainer.local_folder=/home/lucernae/WorkingDir/personal/devcontainer-nix
[2026-02-19T13:27:12.470Z] Stop (17 ms): Run: docker ps -q -a --filter label=devcontainer.local_folder=/home/lucernae/WorkingDir/personal/devcontainer-nix
[2026-02-19T13:27:12.473Z] Start: Run: docker compose version --short
[2026-02-19T13:27:12.531Z] Stop (58 ms): Run: docker compose version --short
[2026-02-19T13:27:12.531Z] Docker Compose version: 2.40.3
[2026-02-19T13:27:12.531Z] Start: Run: docker compose -f /home/lucernae/WorkingDir/personal/devcontainer-nix/.devcontainer/nixos/docker-compose.yml --profile * config
[2026-02-19T13:27:12.604Z] Stop (73 ms): Run: docker compose -f /home/lucernae/WorkingDir/personal/devcontainer-nix/.devcontainer/nixos/docker-compose.yml --profile * config
[2026-02-19T13:27:12.604Z] name: nixos
services:
  devcontainer:
    cap_add:
      - SYS_ADMIN
      - CAP_NET_ADMIN
    cgroup: host
    environment:
      PATH: /bin:/usr/bin:/usr/sbin:/run/current-system/sw/bin/
      TMPDIR: /cont/tmp
      VSCODE_SERVER_CUSTOM_GLIBC_LINKER: "true"
      container: docker
    hostname: devcontainer
    image: ghcr.io/lucernae/devcontainer-nix:nixos-dockertools---latest
    networks:
      default: null
    privileged: true
    stop_signal: SIGRTMIN+3
    tmpfs:
      - /cont/tmp:exec,mode=777
      - /run
      - /run/wrappers
    tty: true
    volumes:
      - type: bind
        source: /home/lucernae/WorkingDir/personal/devcontainer-nix
        target: /workspace
        bind:
          create_host_path: true
      - type: bind
        source: /home/lucernae/WorkingDir/personal/devcontainer-nix/.devcontainer/nixos/etc/nixos/configuration.nix
        target: /etc/nixos/configuration.nix
        bind:
          create_host_path: true
      - type: bind
        source: /var/run/docker.sock
        target: /var/run/docker.sock
        bind:
          create_host_path: true
      - type: bind
        source: /home/lucernae/WorkingDir/personal/devcontainer-nix/.devcontainer/nixos/etc/systemd/system/tmp.mount
        target: /etc/systemd/system/tmp.mount
        bind:
          create_host_path: true
      - type: bind
        source: /sys/fs/cgroup
        target: /sys/fs/cgroup
        bind:
          create_host_path: true
networks:
  default:
    name: nixos_default
[2026-02-19T13:27:12.607Z] Start: Run: docker ps -q -a --filter label=com.docker.compose.project=nixos --filter label=com.docker.compose.service=devcontainer
[2026-02-19T13:27:12.625Z] Stop (18 ms): Run: docker ps -q -a --filter label=com.docker.compose.project=nixos --filter label=com.docker.compose.service=devcontainer
[2026-02-19T13:27:12.625Z] Start: Run: docker inspect --type container d59b2e52f86e
[2026-02-19T13:27:12.643Z] Stop (18 ms): Run: docker inspect --type container d59b2e52f86e
[2026-02-19T13:27:12.644Z] Start: Inspecting container
[2026-02-19T13:27:12.644Z] Start: Run: docker inspect --type container d59b2e52f86ec0a30def71145a12ccb934c26673b6e39705fc54e3985a72eef8
[2026-02-19T13:27:12.662Z] Stop (18 ms): Run: docker inspect --type container d59b2e52f86ec0a30def71145a12ccb934c26673b6e39705fc54e3985a72eef8
[2026-02-19T13:27:12.662Z] Stop (18 ms): Inspecting container
[2026-02-19T13:27:12.663Z] Start: Run in container: /bin/sh
[2026-02-19T13:27:12.667Z] Start: Run in container: uname -m
[2026-02-19T13:27:12.707Z] x86_64
[2026-02-19T13:27:12.707Z] 
[2026-02-19T13:27:12.707Z] Stop (40 ms): Run in container: uname -m
[2026-02-19T13:27:12.707Z] Start: Run in container: (cat /etc/os-release || cat /usr/lib/os-release) 2>/dev/null
[2026-02-19T13:27:12.710Z] ANSI_COLOR="0;38;2;126;186;228"
BUG_REPORT_URL="https://github.com/NixOS/nixpkgs/issues"
BUILD_ID="25.11.6074.fa56d7d6de78"
CPE_NAME="cpe:/o:nixos:nixos:25.11"
DEFAULT_HOSTNAME=nixos
DOCUMENTATION_URL="https://nixos.org/learn.html"
HOME_URL="https://nixos.org/"
ID=nixos
ID_LIKE=""
IMAGE_ID=""
IMAGE_VERSION=""
LOGO="nix-snowflake"
NAME=NixOS
PRETTY_NAME="NixOS 25.11 (Xantusia)"
SUPPORT_END="2026-06-30"
SUPPORT_URL="https://nixos.org/community.html"
VARIANT=""
VARIANT_ID=""
VENDOR_NAME=NixOS
VENDOR_URL="https://nixos.org/"
VERSION="25.11 (Xantusia)"
VERSION_CODENAME=xantusia
VERSION_ID="25.11"
[2026-02-19T13:27:12.710Z] 
[2026-02-19T13:27:12.710Z] Stop (3 ms): Run in container: (cat /etc/os-release || cat /usr/lib/os-release) 2>/dev/null
[2026-02-19T13:27:12.711Z] Start: Run in container:  (command -v getent >/dev/null 2>&1 && getent passwd 'root' || grep -E '^root|^[^:]*:[^:]*:root:' /etc/passwd || true)
[2026-02-19T13:27:12.713Z] Stop (2 ms): Run in container:  (command -v getent >/dev/null 2>&1 && getent passwd 'root' || grep -E '^root|^[^:]*:[^:]*:root:' /etc/passwd || true)
[2026-02-19T13:27:12.713Z] Start: Run in container: test -f '/var/devcontainer/.patchEtcEnvironmentMarker'
[2026-02-19T13:27:12.714Z] 
[2026-02-19T13:27:12.714Z] 
[2026-02-19T13:27:12.714Z] Exit code 1
[2026-02-19T13:27:12.714Z] Stop (1 ms): Run in container: test -f '/var/devcontainer/.patchEtcEnvironmentMarker'
[2026-02-19T13:27:12.715Z] Start: Run in container: test ! -f '/var/devcontainer/.patchEtcEnvironmentMarker' && set -o noclobber && mkdir -p '/var/devcontainer' && { > '/var/devcontainer/.patchEtcEnvironmentMarker' ; } 2> /dev/null
[2026-02-19T13:27:12.717Z] 
[2026-02-19T13:27:12.717Z] 
[2026-02-19T13:27:12.717Z] Stop (2 ms): Run in container: test ! -f '/var/devcontainer/.patchEtcEnvironmentMarker' && set -o noclobber && mkdir -p '/var/devcontainer' && { > '/var/devcontainer/.patchEtcEnvironmentMarker' ; } 2> /dev/null
[2026-02-19T13:27:12.717Z] Start: Run in container: cat >> /etc/environment <<'etcEnvrionmentEOF'
[2026-02-19T13:27:12.719Z] 
[2026-02-19T13:27:12.719Z] 
[2026-02-19T13:27:12.719Z] Stop (2 ms): Run in container: cat >> /etc/environment <<'etcEnvrionmentEOF'
[2026-02-19T13:27:12.720Z] Start: Run in container: test -f '/var/devcontainer/.patchEtcProfileMarker'
[2026-02-19T13:27:12.720Z] 
[2026-02-19T13:27:12.720Z] 
[2026-02-19T13:27:12.720Z] Exit code 1
[2026-02-19T13:27:12.720Z] Stop (0 ms): Run in container: test -f '/var/devcontainer/.patchEtcProfileMarker'
[2026-02-19T13:27:12.720Z] Start: Run in container: test ! -f '/var/devcontainer/.patchEtcProfileMarker' && set -o noclobber && mkdir -p '/var/devcontainer' && { > '/var/devcontainer/.patchEtcProfileMarker' ; } 2> /dev/null
[2026-02-19T13:27:12.723Z] 
[2026-02-19T13:27:12.723Z] 
[2026-02-19T13:27:12.723Z] Stop (3 ms): Run in container: test ! -f '/var/devcontainer/.patchEtcProfileMarker' && set -o noclobber && mkdir -p '/var/devcontainer' && { > '/var/devcontainer/.patchEtcProfileMarker' ; } 2> /dev/null
[2026-02-19T13:27:12.723Z] Start: Run in container: sed -i -E 's/((^|\s)PATH=)([^\$]*)$/\1${PATH:-\3}/g' /etc/profile || true
[2026-02-19T13:27:12.725Z] 
[2026-02-19T13:27:12.725Z] 
[2026-02-19T13:27:12.725Z] Stop (2 ms): Run in container: sed -i -E 's/((^|\s)PATH=)([^\$]*)$/\1${PATH:-\3}/g' /etc/profile || true
[2026-02-19T13:27:12.725Z] Stop (293 ms): Resolving Remote
[Info	- 13:27:12.733] Devcontainer output as JSON: {
    "outcome": "success",
    "containerId": "d59b2e52f86ec0a30def71145a12ccb934c26673b6e39705fc54e3985a72eef8",
    "composeProjectName": "nixos",
    "remoteUser": "root",
    "remoteWorkspaceFolder": "/workspace",
    "configuration": {
        "name": "Nix Devcontainer (NixOS)",
        "dockerComposeFile": [
            "docker-compose.yml"
        ],
        "overrideCommand": false,
        "service": "devcontainer",
        "workspaceFolder": "/workspace",
        "postCreateCommand": "bash -c \"systemctl is-system-running --wait || true && nix-channel --update\"",
        "remoteUser": "root",
        "customizations": {
            "vscode": {
                "extensions": [
                    "ms-azuretools.vscode-docker",
                    "arrterian.nix-env-selector",
                    "bbenoist.Nix",
                    "jnoortheen.nix-ide",
                    "brettm12345.nixfmt-vscode"
                ]
            }
        },
        "configFilePath": {
            "$mid": 1,
            "fsPath": "/home/lucernae/WorkingDir/personal/devcontainer-nix/.devcontainer/nixos/devcontainer.json",
            "path": "/home/lucernae/WorkingDir/personal/devcontainer-nix/.devcontainer/nixos/devcontainer.json",
            "scheme": "file"
        }
    },
    "mergedConfiguration": {
        "name": "Nix Devcontainer (NixOS)",
        "dockerComposeFile": [
            "docker-compose.yml"
        ],
        "overrideCommand": false,
        "service": "devcontainer",
        "workspaceFolder": "/workspace",
        "remoteUser": "root",
        "configFilePath": {
            "$mid": 1,
            "fsPath": "/home/lucernae/WorkingDir/personal/devcontainer-nix/.devcontainer/nixos/devcontainer.json",
            "path": "/home/lucernae/WorkingDir/personal/devcontainer-nix/.devcontainer/nixos/devcontainer.json",
            "scheme": "file"
        },
        "init": false,
        "privileged": false,
        "customizations": {
            "vscode": [
                {
                    "extensions": [
                        "ms-azuretools.vscode-docker",
                        "arrterian.nix-env-selector",
                        "bbenoist.Nix",
                        "jnoortheen.nix-ide",
                        "brettm12345.nixfmt-vscode"
                    ]
                }
            ]
        },
        "onCreateCommands": [],
        "updateContentCommands": [],
        "postCreateCommands": [
            "bash -c \"systemctl is-system-running --wait || true && nix-channel --update\""
        ],
        "postStartCommands": [],
        "postAttachCommands": [],
        "remoteEnv": {},
        "containerEnv": {},
        "portsAttributes": {}
    }
}
[Info	- 13:27:12.733] Found container ID: d59b2e52f86ec0a30def71145a12ccb934c26673b6e39705fc54e3985a72eef8
[Info	- 13:27:12.733] Reading devcontainer configuration with command: "/nix/store/1hh8kycxyiri9cy96n314w8gfy63f4m5-google-antigravity-1.16.5-6703236727046144/lib/antigravity/antigravity" "/nix/store/1hh8kycxyiri9cy96n314w8gfy63f4m5-google-antigravity-1.16.5-6703236727046144/lib/antigravity/resources/app/extensions/antigravity-dev-containers/dist/@devcontainers/cli/dist/spec-node/devContainersSpecCLI.js" read-configuration --workspace-folder "/home/lucernae/WorkingDir/personal/devcontainer-nix" --container-id "d59b2e52f86ec0a30def71145a12ccb934c26673b6e39705fc54e3985a72eef8" --config "/home/lucernae/WorkingDir/personal/devcontainer-nix/.devcontainer/nixos/devcontainer.json"
[Info	- 13:27:12.953] Finished Read Dev Container Configuration.
[Info	- 13:27:12.954] Remote user: root
[Info	- 13:27:12.954] Installing remote server in container...
[Info	- 13:27:12.956] Bash script:

# Server installation script

TMP_DIR="${XDG_RUNTIME_DIR:-"/tmp"}"

DISTRO_VSCODE_VERSION="1.107.0"
DISTRO_IDE_VERSION="1.16.5"
DISTRO_COMMIT="1504c8cc4b34dbfbb4a97ebe954b3da2b5634516"
DISTRO_ID="1504c8cc4b34dbfbb4a97ebe954b3da2b5634516"
DISTRO_QUALITY="stable"
DISTRO_VSCODIUM_RELEASE=""

SERVER_APP_NAME="antigravity-server"
SERVER_INITIAL_EXTENSIONS=""
SERVER_LISTEN_FLAG="--port=0"
SERVER_DATA_DIR="$HOME/.antigravity-server"
SERVER_DIR="$SERVER_DATA_DIR/bin/$DISTRO_IDE_VERSION-$DISTRO_ID"
# Temporarily remove -insiders suffix from SERVER_APP_NAME to point insider cloudtop to stable
SERVER_SCRIPT="$SERVER_DIR/bin/$SERVER_APP_NAME"
SERVER_LOGFILE="$SERVER_DATA_DIR/.$DISTRO_ID.log"
SERVER_PIDFILE="$SERVER_DATA_DIR/.$DISTRO_ID.pid"
SERVER_TOKENFILE="$SERVER_DATA_DIR/.$DISTRO_ID.token"
SERVER_SSH_AGENT_SOCKET="$SERVER_DATA_DIR/.$DISTRO_ID-ssh-auth.sock"
SERVER_ARCH=
SERVER_CONNECTION_TOKEN=
SERVER_DOWNLOAD_URL=

LISTENING_ON=
OS_RELEASE_ID=
ARCH=
PLATFORM=
SERVER_PID=

GLIBC_VERSION_GOOD=

# Add lock mechanism
LOCK_FILE="$SERVER_DATA_DIR/.installation_lock"

# Function to acquire lock
acquire_lock() {
	exec 200>$LOCK_FILE
	echo "Waiting for lock..."
	flock 200
	echo "Lock acquired, proceeding with installation."
}

# Function to release lock
release_lock() {
	flock -u 200
	exec 200>&-
}

trap release_lock EXIT INT TERM

# Mimic output from logs of remote-ssh extension
print_install_results_and_exit() {
	if [[ $1 -eq 1 ]]; then
		echo ""
		echo "Error: installation failed."
		if [[ -f "$SERVER_LOGFILE" ]]; then
			echo "Server log:
 $(cat "$SERVER_LOGFILE")
"
		fi
	fi
	if [[ "$GLIBC_VERSION_GOOD" = "false" ]]; then
		echo "Warning: valid glibc version not found. Antigravity only supports remote connections with glibc >= 2.28, such as Ubuntu 20.04, Debian 10, or CentOS 8."
		echo ""
	fi
	echo "aea1ac0629c072bc0428d62f: start"
	echo "exitCode==$1=="
	echo "listeningOn==$LISTENING_ON=="
	echo "connectionToken==$SERVER_CONNECTION_TOKEN=="
	echo "logFile==$SERVER_LOGFILE=="
	echo "osReleaseId==$OS_RELEASE_ID=="
	echo "arch==$ARCH=="
	echo "platform==$PLATFORM=="
	echo "tmpDir==$TMP_DIR=="
	
	echo "aea1ac0629c072bc0428d62f: end"

	exit 0
}

print_install_results_and_wait() {
	# Check server is indeed running
	if [ -f $SERVER_PIDFILE ]; then
		SERVER_PID="$(cat $SERVER_PIDFILE)"
	else
		print_install_results_and_exit 1
	fi

	echo "aea1ac0629c072bc0428d62f: start"
	# pretend exit code is 0
	echo "exitCode=0"
	echo "listeningOn==$LISTENING_ON=="
	echo "connectionToken==$SERVER_CONNECTION_TOKEN=="
	echo "logFile==$SERVER_LOGFILE=="
	echo "osReleaseId==$OS_RELEASE_ID=="
	echo "arch==$ARCH=="
	echo "platform==$PLATFORM=="
	echo "tmpDir==$TMP_DIR=="
	
	echo "aea1ac0629c072bc0428d62f: end"

	release_lock

	# Wait for server to exit
	while ps -p $SERVER_PID >/dev/null 2>&1
	do
		sleep 10
	done
}

# Check if platform is supported
KERNEL="$(uname -s)"
case $KERNEL in
	Darwin)
		PLATFORM="darwin"
		;;
	Linux)
		PLATFORM="linux"
		;;
	FreeBSD)
		PLATFORM="freebsd"
		;;
	DragonFly)
		PLATFORM="dragonfly"
		;;
	*)
		echo "Error platform not supported: $KERNEL"
		print_install_results_and_exit 1
		;;
esac

# Check machine architecture
ARCH="$(uname -m)"
case $ARCH in
	x86_64 | amd64)
		SERVER_ARCH="x64"
		;;
	armv7l | armv8l)
		SERVER_ARCH="armhf"
		;;
	arm64 | aarch64)
		SERVER_ARCH="arm64"
		;;
	ppc64le)
		SERVER_ARCH="ppc64le"
		;;
	riscv64)
		SERVER_ARCH="riscv64"
		;;
	*)
		echo "Error architecture not supported: $ARCH"
		print_install_results_and_exit 1
		;;
esac

# https://www.freedesktop.org/software/systemd/man/os-release.html
OS_RELEASE_ID="$(grep -i '^ID=' /etc/os-release 2>/dev/null | sed 's/^ID=//gi' | sed 's/"//g')"
if [ -z $OS_RELEASE_ID ]; then
	OS_RELEASE_ID="$(grep -i '^ID=' /usr/lib/os-release 2>/dev/null | sed 's/^ID=//gi' | sed 's/"//g')"
	if [ -z $OS_RELEASE_ID ]; then
		OS_RELEASE_ID="unknown"
	fi
fi

# Create installation folder
if [ ! -d $SERVER_DIR ]; then
	mkdir -p $SERVER_DIR
	if (( $? > 0 )); then
		echo "Error creating server install directory"
		print_install_results_and_exit 1
	fi
fi

# Acquire lock at the beginning of the script
acquire_lock

# Add trap to release lock on exit
trap release_lock EXIT


if [ -n "$SSH_AUTH_SOCK" ]; then
	ln -s -f $SSH_AUTH_SOCK $SERVER_SSH_AGENT_SOCKET
fi
export SSH_AUTH_SOCK=$SERVER_SSH_AGENT_SOCKET

if [[ "$SERVER_ARCH" == "arm64" ]]; then
	SERVER_ARCH="arm"
fi
if [[ "$DISTRO_QUALITY" == "insider" ]]; then
	SERVER_DOWNLOAD_URL="$DISTRO_QUALITY/$DISTRO_IDE_VERSION-$DISTRO_COMMIT/$PLATFORM-$SERVER_ARCH/Antigravity - Insiders-reh.tar.gz"
else
	SERVER_DOWNLOAD_URL="$DISTRO_QUALITY/$DISTRO_IDE_VERSION-$DISTRO_COMMIT/$PLATFORM-$SERVER_ARCH/Antigravity-reh.tar.gz"
fi

if [[ "$PLATFORM" == "linux" ]]; then
	# Check ldd version based on format "ldd (.*) 2.28"
	version=$(ldd --version | head -n 1 | grep -oE '[0-9]+.[0-9]+$')
	if (( $? > 0 )); then
		echo "Warning: ldd not found"
		GLIBC_VERSION_GOOD="false"
	else
		major=$(echo "$version" | cut -d '.' -f 1)
		minor=$(echo "$version" | cut -d '.' -f 2)

		if [[ "$major" -eq 2 && "$minor" -ge 28 ]]; then
			GLIBC_VERSION_GOOD="true"
		else
			GLIBC_VERSION_GOOD="false"
		fi
	fi

	if [[ "$GLIBC_VERSION_GOOD" = "false" ]]; then
		echo "Warning: valid glibc version not found. Antigravity only supports remote connections with glibc >= 2.28, such as Ubuntu 20.04, Debian 10, or CentOS 8."
	fi
fi

# Check if server script is already installed
if [ ! -f $SERVER_SCRIPT ]; then
	if [ "$PLATFORM" != "darwin" ] && [ "$PLATFORM" != "linux" ]; then
		echo "Error "$PLATFORM" needs manual installation of remote extension host"
		print_install_results_and_exit 1
	fi

	pushd $SERVER_DIR > /dev/null

	temp_file=$(mktemp)

	DOWNLOAD_URLS=(
		"https://edgedl.me.gvt1.com/edgedl/release2/j0qc3/antigravity/$SERVER_DOWNLOAD_URL"
		"https://redirector.gvt1.com/edgedl/release2/j0qc3/antigravity/$SERVER_DOWNLOAD_URL"
		"https://edgedl.me.gvt1.com/edgedl/antigravity/$SERVER_DOWNLOAD_URL"
		"https://redirector.gvt1.com/edgedl/antigravity/$SERVER_DOWNLOAD_URL"
	)

	download_success=0
	for url in "${DOWNLOAD_URLS[@]}"; do
		if [ ! -z $(which wget) ]; then
			wget --tries=3 --timeout=10 --continue --quiet -O $temp_file "$url"
		else
			echo "Error need wget to download server binary"
			print_install_results_and_exit 1
		fi

		if (( $? == 0 )); then
			download_success=1
			break
		else
			echo "Download failed from $url, trying next URL..."
		fi
	done

	if (( download_success == 0 )); then
		echo "Error downloading server from all URLs"
		print_install_results_and_exit 1
	fi

	mv $temp_file vscode-server.tar.gz

	tar -xf vscode-server.tar.gz --strip-components 1
	if (( $? > 0 )); then
		echo "Error while extracting server contents"
		print_install_results_and_exit 1
	fi

	if [ ! -f $SERVER_SCRIPT ]; then
		echo "Error server contents are corrupted"
		print_install_results_and_exit 1
	fi

	rm -f vscode-server.tar.gz

	popd > /dev/null
else
	echo "Server script already installed in $SERVER_SCRIPT"
fi

# Try to find if server is already running
if [ -f $SERVER_PIDFILE ]; then
	SERVER_PID="$(cat $SERVER_PIDFILE)"
	SERVER_RUNNING_PROCESS="$(ps -o pid,args -p $SERVER_PID | grep $SERVER_SCRIPT)"
else
	SERVER_RUNNING_PROCESS="$(ps -o pid,args -A | grep $SERVER_SCRIPT | grep -v grep)"
	if [ -z $SERVER_RUNNING_PROCESS ]; then
		SERVER_PID=
	else
		SERVER_PID="$(echo $SERVER_RUNNING_PROCESS | cut -d ' ' -f 1 | head -n 1)"
	fi
fi

if [ -z "$SERVER_RUNNING_PROCESS" ]; then
	if [ -f "$SERVER_LOGFILE" ]; then
		rm $SERVER_LOGFILE
	fi
	if [ -f "$SERVER_TOKENFILE" ]; then
		rm $SERVER_TOKENFILE
	fi

	touch $SERVER_TOKENFILE
	chmod 600 $SERVER_TOKENFILE
	SERVER_CONNECTION_TOKEN="422182338636"
	echo $SERVER_CONNECTION_TOKEN > $SERVER_TOKENFILE

	export REMOTE_CONTAINERS=true

	$SERVER_SCRIPT --start-server --host=127.0.0.1 $SERVER_LISTEN_FLAG $SERVER_INITIAL_EXTENSIONS --connection-token-file $SERVER_TOKENFILE --telemetry-level off --enable-remote-auto-shutdown --accept-server-license-terms &> $SERVER_LOGFILE & disown
	echo $! > $SERVER_PIDFILE
else
	echo "Server script is already running $SERVER_SCRIPT"
fi

if [ -f $SERVER_TOKENFILE ]; then
	SERVER_CONNECTION_TOKEN="$(cat $SERVER_TOKENFILE)"
else
	echo "Error server token file not found $SERVER_TOKENFILE"
	print_install_results_and_exit 1
fi

if [ -f "$SERVER_LOGFILE" ]; then
	for i in {1..5}; do
		LISTENING_ON="$(cat $SERVER_LOGFILE | grep -E 'Extension host agent listening on .+' | sed 's/Extension host agent listening on //')"
		if [ -n "$LISTENING_ON" ]; then
			break
		fi
		sleep 0.5
	done

	if [ -z "$LISTENING_ON" ]; then
		echo "Error server did not start sucessfully"
		print_install_results_and_exit 1
	fi
else
	echo "Error server log file not found $SERVER_LOGFILE"
	print_install_results_and_exit 1
fi

# Finish server setup
print_install_results_and_exit 0

[Info	- 13:27:12.956] Install options: {
  "id": "aea1ac0629c072bc0428d62f",
  "vscodeVersion": "1.107.0",
  "ideVersion": "1.16.5",
  "commit": "1504c8cc4b34dbfbb4a97ebe954b3da2b5634516",
  "quality": "stable",
  "extensionIds": [],
  "envVariables": [],
  "useSocketPath": false,
  "serverApplicationName": "antigravity-server",
  "serverDataFolderName": ".antigravity-server",
  "distroId": "1504c8cc4b34dbfbb4a97ebe954b3da2b5634516"
}
[Info	- 13:27:13.80] SSH Agent Forwarding: true
[Error	- 13:27:32.850] wget: note: TLS certificate validation not implemented

